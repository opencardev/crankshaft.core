# Project: Crankshaft
# This file is part of Crankshaft project.
# Copyright (C) 2025 OpenCarDev Team
#
#  Crankshaft is free software: you can redistribute it and/or modify
#  it under the terms of the GNU General Public License as published by
#  the Free Software Foundation; either version 3 of the License, or
#  (at your option) any later version.
#
#  Crankshaft is distributed in the hope that it will be useful,
#  but WITHOUT ANY WARRANTY; without even the implied warranty of
#  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
#  GNU General Public License for more details.
#
#  You should have received a copy of the GNU General Public License
#  along with Crankshaft. If not, see <http://www.gnu.org/licenses/>.

name: CD

on:
  workflow_run:
    workflows: ["CI"]
    branches:
      - main
    types:
      - completed

  workflow_dispatch:
    inputs:
      build_run_id:
        description: 'Build run ID from CI workflow (optional, uses latest CI success if empty)'
        required: false
        type: string
      distribution:
        description: 'Distribution to publish to'
        required: false
        default: 'trixie'
        type: choice
        options:
          - trixie
          - bookworm
          - both

permissions:
  actions: write
  contents: read

jobs:
  publish-apt:
    runs-on: ubuntu-latest
    if: ${{ (github.event.workflow_run.conclusion == 'success' && github.event_name == 'workflow_run' ) || github.event_name == 'workflow_dispatch' }}
    steps:
      - name: Trigger APT Repository Update
        uses: actions/github-script@v7
        with:
          script: |
            console.log('Triggering APT publish');
            let runId = (context.payload.workflow_run && context.payload.workflow_run.id) || (context.payload.inputs && context.payload.inputs.build_run_id) || '';
            // Fallback: lookup latest successful CI run on main when runId is empty
            if (!runId) {
              const workflows = await github.rest.actions.listRepoWorkflows({ owner: context.repo.owner, repo: context.repo.repo });
              const ciWf = workflows.data.workflows.find(w => w.name === 'CI');
              if (!ciWf) { throw new Error('CI workflow not found'); }
              const runs = await github.rest.actions.listWorkflowRuns({ owner: context.repo.owner, repo: context.repo.repo, workflow_id: ciWf.id, branch: 'main', status: 'success', per_page: 1 });
              if (runs.data.workflow_runs && runs.data.workflow_runs.length > 0) {
                runId = String(runs.data.workflow_runs[0].id);
                console.log(`Resolved latest successful CI runId: ${runId}`);
              } else {
                throw new Error('No successful CI runs found on main');
              }
            }
            // Resolve workflow id for trigger-apt-publish by name
            const list = await github.rest.actions.listRepoWorkflows({ owner: context.repo.owner, repo: context.repo.repo });
            const aptWf = list.data.workflows.find(w => (w.name === 'Trigger APT Repository Update') || (w.path && w.path.endsWith('/trigger-apt-publish.yml')));
            if (!aptWf) { throw new Error('trigger-apt-publish workflow not found'); }
            await github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: aptWf.id,
              ref: 'main',
              inputs: {
                build_run_id: String(runId),
                distribution: (context.payload.inputs && context.payload.inputs.distribution) || 'trixie'
              }
            });

  test-apt-install:
    needs: publish-apt
    runs-on: ubuntu-latest
    if: needs.publish-apt.result == 'success'
    strategy:
      matrix:
        arch: [amd64, arm64, armhf]
        suite: [trixie]
    steps:
      - name: Set up QEMU for multi-arch
        if: matrix.arch != 'amd64'
        uses: docker/setup-qemu-action@v3
        with:
          platforms: linux/${{ matrix.arch }}

      - name: Test package installation
        run: |
          # Wait for APT repository to be published
          echo "Waiting 60 seconds for APT repository to be published..."
          sleep 60
          
          # Determine platform for Docker
          PLATFORM="linux/${{ matrix.arch }}"
          if [ "${{ matrix.arch }}" = "armhf" ]; then
            PLATFORM="linux/arm/v7"
          fi
          
          echo "Testing installation on $PLATFORM with Debian ${{ matrix.suite }}"
          
          docker run --platform=$PLATFORM --rm debian:${{ matrix.suite }}-slim bash -c "
            set -e
            echo '=== Installing prerequisites ==='
            apt-get update
            apt-get install -y curl gnupg
            
            echo '=== Adding OpenCarDev repository ==='
            curl -fsSL https://opencardev.github.io/packages/opencardev.gpg.key | gpg --dearmor -o /usr/share/keyrings/opencardev-archive-keyring.gpg
            echo 'deb [arch=\$(dpkg --print-architecture) signed-by=/usr/share/keyrings/opencardev-archive-keyring.gpg] https://opencardev.github.io/packages ${{ matrix.suite }} nightly' > /etc/apt/sources.list.d/opencardev.list
            
            echo '=== Updating package lists ==='
            apt-get update
            
            echo '=== Installing Crankshaft packages ==='
            apt-get install -y libaasdk0 libaasdk-dev crankshaft-core crankshaft-ui
            
            echo '=== Verifying installations ==='
            dpkg -l | grep -E 'libaasdk|crankshaft'
            
            echo '=== Checking installed files ==='
            ls -la /usr/bin/crankshaft-* || true
            ls -la /usr/lib/crankshaft/ || true
            ls -la /lib/udev/rules.d/99-crankshaft.rules || true
            ls -la /lib/systemd/system/crankshaft-*.service || true
            
            echo '✅ Package installation test passed on ${{ matrix.arch }}'
          "

      - name: Report test result
        if: always()
        run: |
          if [ "${{ job.status }}" = "success" ]; then
            echo "✅ APT installation test passed for ${{ matrix.arch }} on ${{ matrix.suite }}"
          else
            echo "❌ APT installation test failed for ${{ matrix.arch }} on ${{ matrix.suite }}"
            exit 1
          fi

  build-pi-images:
    needs: test-apt-install
    runs-on: ubuntu-latest
    if: needs.test-apt-install.result == 'success'
    steps:
      - name: Trigger Pi-Gen Build
        uses: actions/github-script@v7
        with:
          script: |
            const wr = context.payload.workflow_run || {};
            const headBranch = wr.head_branch || 'main';
            const runNumber = wr.run_number || 0;
            const version = `${headBranch}-${runNumber}`;
            // Resolve workflow id for build-pi-gen-lite by name
            const list = await github.rest.actions.listRepoWorkflows({ owner: context.repo.owner, repo: context.repo.repo });
            const piGenWf = list.data.workflows.find(w => (w.name === 'build-pi-gen-lite') || (w.path && w.path.endsWith('/build-pi-gen-lite.yml')));
            if (!piGenWf) { throw new Error('build-pi-gen-lite workflow not found'); }
            await github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: piGenWf.id,
              ref: 'main',
              inputs: {
                version,
                release: 'trixie',
                auto_release: 'false',
                create_release_draft: 'false'
              }
            });
