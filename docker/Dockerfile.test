# Project: Crankshaft
# This file is part of Crankshaft project.
# Copyright (C) 2025 OpenCarDev Team
#
#  Crankshaft is free software: you can redistribute it and/or modify
#  it under the terms of the GNU General Public License as published by
#  the Free Software Foundation; either version 3 of the License, or
#  (at your option) any later version.
#
#  Crankshaft is distributed in the hope that it will be useful,
#  but WITHOUT ANY WARRANTY; without even the implied warranty of
#  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
#  GNU General Public License for more details.
#
#  You should have received a copy of the GNU General Public License
#  along with Crankshaft. If not, see <http://www.gnu.org/licenses/>.

ARG SUITE=trixie
FROM debian:${SUITE}-slim

ARG SUITE

RUN set -e \
    && echo "=== Installing prerequisites ===" \
    && apt-get update \
    && apt-get install -y --no-install-recommends curl gnupg ca-certificates \
    && rm -rf /var/lib/apt/lists/*

# Add OpenCarDev APT repo
RUN set -e \
    && echo "=== Adding OpenCarDev repository ===" \
    && curl -fsSL https://opencardev.github.io/packages/opencardev.gpg.key | gpg --dearmor -o /usr/share/keyrings/opencardev-archive-keyring.gpg \
    && ARCH=$(dpkg --print-architecture) \
    && echo "deb [arch=${ARCH} signed-by=/usr/share/keyrings/opencardev-archive-keyring.gpg] https://opencardev.github.io/packages ${SUITE} nightly" > /etc/apt/sources.list.d/opencardev.list

# Install target packages
RUN set -e \
    && echo "=== Updating package lists ===" \
    && apt-get update \
    && echo "=== Installing Crankshaft packages ===" \
    && apt-get install -y --no-install-recommends libaasdk0 libaasdk-dev crankshaft-core crankshaft-ui \
    && rm -rf /var/lib/apt/lists/*

# Verification script
COPY --chown=root:root <<'EOF' /usr/local/bin/verify.sh
#!/bin/sh
set -e

dpkg -l | grep -E "libaasdk|crankshaft" || true
ls -la /usr/bin/crankshaft-* || true
ls -la /usr/lib/crankshaft/ || true
ls -la /lib/udev/rules.d/99-crankshaft.rules || true
ls -la /lib/systemd/system/crankshaft-*.service || true

echo "âœ… Package installation test commands executed"
EOF
RUN chmod +x /usr/local/bin/verify.sh

CMD ["/usr/local/bin/verify.sh"]
